
# 0. ゴールと前提

## 0.1 ゴール

* LINEの通常チャットではなく、**LIFFのWebページ内だけで**以下を完結させる：

  1. 面談日を予約し、Googleカレンダーに予定を作成する
  2. 「休む日」を指定し、Googleカレンダーに休日予定を作成する
* 既存GASの**挙動・選択肢・文字列（イベント名・確認メッセージなど）をできるだけ維持**する。
* フロントは GitHub Pages でホスト → **表示・操作は高速**
* バックエンドは最小限の GAS（Web API）として動かす。

## 0.2 旧システムの重要ポイント（抜粋）

### 面談予約フロー（旧チャット型）

1. 生徒が LINE で「面談予約」と送信

2. GAS `doPost(e)` が受信し、`decidemeetingtype(userId)` を実行 → 「面談タイプ」ボタン送信

   * 選択肢：`"面談"`, `"特訓"`, `"強制通塾"`

3. 生徒が「面談タイプ:面談」などのテキストを返す

4. `testreservation_of_Weeklymeeting(userId)` → 7日分の日付候補ボタン送信

   * 内部的には `getDateArray(today)` で

     * 表示用：`"MM/DD(曜)"`
     * 値：`"yyyy-MM-dd"`

5. 生徒が「面談日:2025-12-04」のようなテキストを返す

6. `get_time_of_meeting(userId)` → 来塾時間のボタン送信

   * 表示（ラベル）と内部値の対応（**厳密**）：

   | ラベル         | 内部値 (`taiou[i]`) |
   | ----------- | ---------------- |
   | 午前~15:00    | `"T14:00:00"`    |
   | 15:00~16:00 | `"T15:00:00"`    |
   | 16:00~17:00 | `"T16:00:00"`    |
   | 17:00~18:00 | `"T17:00:00"`    |
   | 18:00~19:00 | `"T18:00:00"`    |
   | 19:00~20:00 | `"T19:00:00"`    |
   | 20:00~21:00 | `"T20:00:00"`    |
   | 21:00~22:00 | `"T21:00:00"`    |

   * 生徒に送られるテキスト例：`"来塾時間:T17:00:00"`

7. 生徒が「来塾時間:T17:00:00」と返す

8. `get_out_of_meeting(userId)` → 退塾時間のボタン送信

   * 表示（ラベル）は同じだが内部値が異なる：

   | ラベル         | 内部値 (`taiou[i]`) |
   | ----------- | ---------------- |
   | 午前~15:00    | `"T15:00:00"`    |
   | 15:00~16:00 | `"T16:00:00"`    |
   | 16:00~17:00 | `"T17:00:00"`    |
   | 17:00~18:00 | `"T18:00:00"`    |
   | 18:00~19:00 | `"T19:00:00"`    |
   | 19:00~20:00 | `"T20:00:00"`    |
   | 20:00~21:00 | `"T21:00:00"`    |
   | 21:00~22:00 | `"T22:00:00"`    |

   * 生徒に送られるテキスト例：`"退塾時間:T18:00:00"`

9. 生徒が「退塾時間:T18:00:00」と返す

10. `doPost`が過去のメッセージを逆順にたどって、以下4つを `recentcontents` に格納（新しい順）：

    ```text
    0: "退塾時間:T18:00:00"
    1: "来塾時間:T17:00:00"
    2: "面談日:2025-12-04"
    3: "面談タイプ:面談"
    ```

11. `recentcontents.length == 4` のとき `createmeetingevent(recentcontents, userId)` 実行：

    ```js
    var meetingtype    = array[3].slice(6); // "面談タイプ:" を除いた部分 → "面談"
    var meetingday     = array[2].slice(4); // "面談日:"を除いた部分 → "2025-12-04"
    var meetingcometime= array[1].slice(5); // "来塾時間:"除去 → "T17:00:00"
    var meetingouttime = array[0].slice(5); // "退塾時間:"除去 → "T18:00:00"
    ```

    * `getStudentLineId()` で `userId → 生徒名` に対応付け：

      ```js
      const studentdata = new StudentMasterLib.studentMaster().data;
      // 各要素は { 生徒LINEID, 名前, ... }
      ```

    * カレンダーイベント：

      ```js
      var title = seitoname + "さんの" + meetingtype;
      var start = new Date(meetingday + meetingcometime); // "2025-12-04T17:00:00"
      var end   = new Date(meetingday + meetingouttime);  // "2025-12-04T18:00:00"
      calendar.createEvent(title, start, end);
      ```

    * 生徒への確認メッセージ：

      ```text
      {生徒名}さんの{面談タイプ}は{yyyy-MM-dd}T開始時刻から{yyyy-MM-dd}T終了時刻までで予約完了しました！
      ```

### 休み登録フロー（旧チャット型）

1. 生徒が LINE で「休みたい」と送信
2. `rest_of_Weeklymeeting(userId, today, "0")` が、
   今日から7日分 + 「次週」ボタンを Flex で送信（内容は `getDateArray` を利用）
3. 生徒が「休む日:+1週間」などと送ると、`doPost` で

   * 週数 `week` を取り出し (`slice(5, leng-2)`)、その週の開始日を計算し、
   * その日付を基準に再度 `rest_of_Weeklymeeting` を呼んで候補を出し直す。
4. 生徒が「休む日:2025-12-05」と送信
5. `createrestevent([ "休む日:2025-12-05" ], userId)` が実行される：

   ```js
   var time = array[0].slice(4); // "休む日:" を除去 → "2025-12-05"
   var title = seitoname + "さんの休日";
   var start = new Date(time + "T18:00:00");
   var end   = new Date(time + "T22:00:00");
   event.setColor(4); // カラー4
   ```

   * 確認メッセージ：

     ```text
     {生徒名}さんの休む日は{yyyy-MM-dd}で登録しました！
     ```

---

# 1. 新アーキテクチャ概要

## 1.1 全体構成

* **フロントエンド**

  * LIFFアプリ
  * GitHub Pages に `index.html` / `app.js` / `style.css` としてホスト
  * LIFF SDK を用いて `userId` を取得し、フォーム送信時に GAS API に送る

* **バックエンド（GAS）**

  * Webアプリとして公開された1本のURL（例：`https://script.google.com/macros/s/XXX/exec`）
  * `doPost(e)` で JSON を受け取り、`action` で分岐：

    * `reserveMeeting` : 面談予約 → カレンダー登録
    * `registerRestDay` : 休み登録 → カレンダー登録

* **データ**

  * 既存の `StudentMasterLib.studentMaster().data` をそのまま利用

    * 各要素は少なくとも `{ 生徒LINEID, 名前 }` を持つ前提
  * Googleカレンダーは `CalendarApp.getDefaultCalendar()` を使用（現行と同じ）

## 1.2 旧Webhookは不要にする想定

* 旧 `doPost(e)`（LINE Messaging API Webhook用）の「条件分岐＆チャット制御部分」は**基本撤廃**し、
* 新しい `doPost(e)` は **LIFFフロントからの JSON API リクエスト専用**にする。
* （チャットで「面談予約」「休みたい」と打ったら…という旧フローは使わない）

---

# 2. フロントエンド仕様（LIFF + GitHub Pages）

## 2.1 使用技術

* HTML + CSS + JavaScript（フレームワークは任意）
* 外部ライブラリ：

  * LIFF SDK
* ホスティング：

  * GitHub Pages（`https://<username>.github.io/<repo>/`）

## 2.2 LIFF 初期化

1. `liff.init({ liffId: "<LIFF_ID>" })` を実行
2. `liff.isLoggedIn()` が false の場合は `liff.login()`
3. `const profile = await liff.getProfile()`

   * `profile.userId` → GAS に渡す `userId`
   * `profile.displayName` → 画面表示のため（任意）

以降のリクエストには必ず `userId` を含める。

---

## 2.3 画面構成

### 2.3.1 トップ画面

* 項目：

  * タイトル：例「◯◯塾 LIFFメニュー」
  * テキスト：`{displayName} さん、こんにちは`
  * ボタン：

    * 「面談を予約する」
    * 「休む日を登録する」
* ボタン押下でそれぞれ専用フォーム画面に遷移（SPAでもページ遷移でもOK）。

---

### 2.3.2 面談予約フォーム画面

#### 入力項目

1. **面談タイプ**

   * プルダウン or ラジオボタン
   * 選択肢（**ラベル・値ともに完全一致**させること）：

     ```text
     "面談"
     "特訓"
     "強制通塾"
     ```

2. **面談日**

   * 日付入力 UI（カレンダーUI または候補ボタン）

   * 選択肢は旧 `getDateArray(today)` と同様、**「今日から7日分」を基本**とする。

   * 内部値フォーマット（バックエンドに渡す形）：

     ```text
     "yyyy-MM-dd"  （例："2025-12-04"）
     ```

   * 表示ラベルとして旧 `"MM/DD(曜)"` を使う場合の変換ロジック（参考）：

     ```js
     function getDateOptions(today = new Date()) {
       const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
       const options = [];
       for (let i = 0; i < 7; i++) {
         const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() + i);
         const yyyy = d.getFullYear();
         const mm = ('0' + (d.getMonth() + 1)).slice(-2);
         const dd = ('0' + d.getDate()).slice(-2);
         const w = weekdays[d.getDay()];
         options.push({
           label: `${mm}/${dd}(${w})`,
           value: `${yyyy}-${mm}-${dd}`
         });
       }
       return options;
     }
     ```

3. **来塾時間**

   * 選択肢（UIラベルと内部値の対応を**現行通り**に保つ）：

     ```text
     ラベル           → 内部値 arrivalTime
     -----------------------------------
     午前~15:00       → "T14:00:00"
     15:00~16:00      → "T15:00:00"
     16:00~17:00      → "T16:00:00"
     17:00~18:00      → "T17:00:00"
     18:00~19:00      → "T18:00:00"
     19:00~20:00      → "T19:00:00"
     20:00~21:00      → "T20:00:00"
     21:00~22:00      → "T21:00:00"
     ```

   * バックエンドに渡すフィールド名：`arrivalTime`（文字列）

4. **退塾時間**

   * 選択肢（UIラベルは同じ、内部値だけ変える）：

     ```text
     ラベル           → 内部値 leaveTime
     -----------------------------------
     午前~15:00       → "T15:00:00"
     15:00~16:00      → "T16:00:00"
     16:00~17:00      → "T17:00:00"
     17:00~18:00      → "T18:00:00"
     18:00~19:00      → "T19:00:00"
     19:00~20:00      → "T20:00:00"
     20:00~21:00      → "T21:00:00"
     21:00~22:00      → "T22:00:00"
     ```

   * バックエンドに渡すフィールド名：`leaveTime`（文字列）

#### バリデーション

* 必須：`meetingType`, `date`, `arrivalTime`, `leaveTime`
* 可能であれば：

  * `date` は今日以降
  * `date + arrivalTime < date + leaveTime` になるようチェック

#### 送信（POST）仕様

* エンドポイント：`https://script.google.com/macros/s/XXX/exec`
* メソッド：`POST`
* ヘッダー：`Content-Type: application/json`
* ボディ例：

```json
{
  "action": "reserveMeeting",
  "userId": "<LINE_USER_ID>",
  "date": "2025-12-04",
  "meetingType": "面談",
  "arrivalTime": "T17:00:00",
  "leaveTime": "T18:00:00"
}
```

#### UI挙動

* 送信ボタン押下後：

  * ボタンを一時的に無効化
  * 「送信中…」表示
* レスポンス `status == "ok"` → 「予約が完了しました」など表示
* `status == "error"` の場合は `message` を表示

---

### 2.3.3 休み登録フォーム画面

#### 入力項目

1. **休む日**

   * 日付入力 UI（カレンダー等）

   * 内部値：`"yyyy-MM-dd"`

   > 旧仕様では「今日から7日＋次週」などの複雑な週移動ロジックがあるが、
   > LIFF版では **シンプルに「任意の日付を1日指定」**でも良い。
   > もし旧挙動をトレースしたい場合は、面談日と同じ `getDateArray` ロジックをベースに複数候補を出す。

#### 送信（POST）仕様

* エンドポイント：`https://script.google.com/macros/s/XXX/exec`
* メソッド：`POST`
* ボディ例：

```json
{
  "action": "registerRestDay",
  "userId": "<LINE_USER_ID>",
  "date": "2025-12-05"
}
```

#### カレンダー上の仕様（旧 `createrestevent` に基づく）

* イベントタイトル：

  ```text
  {生徒名}さんの休日
  ```

* 開始時刻：`date + "T18:00:00"`

* 終了時刻：`date + "T22:00:00"`

* カラー：`event.setColor(4)`

* 確認メッセージ（LINE pushを続ける場合）：

  ```text
  {生徒名}さんの休む日は{yyyy-MM-dd}で登録しました！
  ```

---

# 3. バックエンド仕様（GAS Web API）

## 3.1 エンドポイントと共通仕様

* URL例：

  ```text
  https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXX/exec
  ```

* 受信形式：

  * メソッド：`POST`
  * `Content-Type: application/json`
  * `e.postData.contents` を JSON.parse して利用

* レスポンス形式（共通）：

```js
function jsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
```

* 正常系：

```json
{ "status": "ok" }
```

* エラー例：

```json
{ "status": "error", "message": "エラーの説明" }
```

## 3.2 doPost の構造

```js
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    if (action === 'reserveMeeting') {
      return handleReserveMeeting(data);
    } else if (action === 'registerRestDay') {
      return handleRegisterRestDay(data);
    } else {
      return jsonResponse({ status: 'error', message: 'unknown action' });
    }
  } catch (err) {
    Logger.log(err);
    return jsonResponse({ status: 'error', message: err.message });
  }
}
```

---

## 3.3 共通ユーティリティ：生徒名と存在チェック

### 3.3.1 getStudentLineId（現行を再利用）

```js
function getStudentLineId() {
  var lineid = [];
  var name = [];
  const studentdata = new StudentMasterLib.studentMaster().data;
  for (var l = 0; l < studentdata.length; l++) {
    lineid.push(studentdata[l].生徒LINEID);
    name.push(studentdata[l].名前);
  }
  return [lineid, name]; // [ [lineId...], [名前...] ]
}
```

### 3.3.2 userId → name 変換 + 存在チェック

```js
function getStudentNameByUserId(userId) {
  var seitonameid = getStudentLineId();
  var seitoidarray = seitonameid[0];
  var seitonamearray = seitonameid[1];
  var idx = seitoidarray.indexOf(userId);
  if (idx === -1) return null;
  return seitonamearray[idx];
}
```

### 3.3.3 未登録ユーザーへのエラー対応（文字列を引き継ぐ）

旧 `doPost` で未登録時に送っていたメッセージ：

```text
LINEIDが登録されていないため、面談を予約することができません。LINEIDを登録するには登録作業が必要ですので綿引までお問い合わせください。
```

新APIでは：

* `getStudentNameByUserId(userId)` が null の場合、

  ```js
  return jsonResponse({
    status: 'error',
    message: 'LINEIDが登録されていないため、面談を予約することができません。LINEIDを登録するには登録作業が必要ですので綿引までお問い合わせください。'
  });
  ```

* 必要ならここで LINE に push も可能だが、仕様としてはレスポンス側だけでもOK。

---

## 3.4 面談予約 API: `handleReserveMeeting`

### 3.4.1 入力 JSON

```json
{
  "action": "reserveMeeting",
  "userId": "<LINE_USER_ID>",
  "date": "2025-12-04",
  "meetingType": "面談",
  "arrivalTime": "T17:00:00",
  "leaveTime": "T18:00:00"
}
```

### 3.4.2 処理詳細

1. `userId` から生徒名取得：

   ```js
   var name = getStudentNameByUserId(data.userId);
   if (!name) { ... 未登録エラー ... }
   ```

2. 引数をそのまま利用して日時を組み立て：

   ```js
   var meetingday      = data.date;          // "2025-12-04"
   var meetingcometime = data.arrivalTime;  // "T17:00:00"
   var meetingouttime  = data.leaveTime;    // "T18:00:00"

   var start = new Date(meetingday + meetingcometime);
   var end   = new Date(meetingday + meetingouttime);
   ```

   > これは現行 `createmeetingevent` と同じロジック。

3. カレンダーへの登録：

   ```js
   var calendar = CalendarApp.getDefaultCalendar();
   var title = name + "さんの" + data.meetingType;
   var event = calendar.createEvent(title, start, end);
   Logger.log('イベントが作成されました。イベントID: ' + event.getId());
   ```

4. （任意）LINE push で確認メッセージ送信（現行の文言を引き継ぐ）：

   ```js
   var message =
     name + "さんの" + data.meetingType +
     "は" + meetingday + meetingcometime +
     "から" + meetingday + meetingouttime +
     "までで予約完了しました！";
   // これを sendLineMessage(userId, message) などで送信
   ```

5. APIレスポンス：

   ```js
   return jsonResponse({ status: 'ok' });
   ```

---

## 3.5 休み登録 API: `handleRegisterRestDay`

### 3.5.1 入力 JSON

```json
{
  "action": "registerRestDay",
  "userId": "<LINE_USER_ID>",
  "date": "2025-12-05"
}
```

### 3.5.2 処理詳細

1. `userId` から生徒名取得（同上）

2. 日付文字列を取得：

   ```js
   var time = data.date; // "2025-12-05"
   ```

3. カレンダー登録（現行 `createrestevent` と同様）：

   ```js
   var calendar = CalendarApp.getDefaultCalendar();
   var title = name + "さんの休日";
   var start = new Date(time + "T18:00:00");
   var end   = new Date(time + "T22:00:00");

   var event = calendar.createEvent(title, start, end);
   event.setColor(4);
   Logger.log('イベントが作成されました。イベントID: ' + event.getId());
   ```

4. （任意）LINE push で確認メッセージ：

   ```js
   var message = name + "さんの" + "休む日" + "は" + time + "で登録しました！";
   ```

5. APIレスポンス：

   ```js
   return jsonResponse({ status: 'ok' });
   ```

---

# 4. LINEメッセージ送信用の補助関数（必要なら）

旧コードと同じ書式で push する場合：

```js
var access_token = "..." // ★公開リポジトリに絶対載せない

function sendLineMessage(to, message) {
  var url = "https://api.line.me/v2/bot/message/push";
  var payload = {
    "to": to,
    "messages": [{ "type": "text", "text": message }]
  };
  var options = {
    "method": "post",
    "contentType": "application/json",
    "headers": { "Authorization": "Bearer " + access_token },
    "payload": JSON.stringify(payload)
  };
  var response = UrlFetchApp.fetch(url, options);
  Logger.log("Sent to " + to + ": " + response.getResponseCode());
}
```

`handleReserveMeeting` / `handleRegisterRestDay` 内で必要に応じて呼び出す。

